Este documento define los **aspectos estructurales y técnicos** que aplican a todo el sistema,
independientemente del módulo funcional.

---

## Arquitectura General

### Modelo SaaS Multi-tenant

El sistema es un **SaaS multi-tenant**.

- Una única plataforma
- Múltiples clientes (empresas)
- Cada empresa:
  - Tiene su propia configuración
  - Administra sus propias páginas
  - Accede únicamente a sus datos
- No hay cruce de información entre empresas

El tenant principal del sistema es la **Empresa**.

---

## Modelo de Acceso y Roles

### Usuarios
- Un usuario puede:
  - Pertenecer a una o varias empresas
  - Tener distintos roles por empresa

### Roles (iniciales)
Los roles son **por empresa**, no globales.

Ejemplo base:
- **Owner**
  - Control total
  - Billing
  - Configuración
- **Admin**
  - Gestión operativa
  - Servicios, agenda, CRM
- **Staff**
  - Gestión de citas
  - Visualización de clientes
- **Viewer**
  - Solo lectura
  - Analytics / reportes

> Los roles controlan **qué módulos y acciones están disponibles**.

---

## Módulos Transversales del Sistema

Estos módulos **no pertenecen a un dominio funcional**, pero son usados por todos.

---

## T1 — Autenticación y Autorización

**Responsabilidad:** Control de acceso seguro al sistema.

Incluye:
- Login / logout
- Gestión de sesión
- Asociación usuario ↔ empresa
- Control de permisos por rol
- Protección de rutas y acciones

Características:
- Multi-tenant aware
- Roles por empresa
- Base para feature flags por plan

---

## T2 — Gestión de Layout y Dashboard

**Responsabilidad:** Experiencia consistente en el panel administrativo.

Incluye:
- Layout base del dashboard
- Navegación por módulos
- Sidebar contextual según rol y plan
- Header global (empresa activa, usuario, notificaciones)

Aplica a:
- Todos los módulos internos
- No a la web pública

---

## T3 — Feature Flags y Planes

**Responsabilidad:** Gobernar qué funcionalidades están activas.

Incluye:
- Activación por plan:
  - Basic
  - Pro
  - Enterprise
- Activación por rol
- Activación progresiva (rollout)

Ejemplos:
- Agente IA solo en PRO+
- Pago anticipado solo en PRO+
- Analytics avanzadas solo en PRO+

---

## T4 — Sistema de Notificaciones

**Responsabilidad:** Envío de mensajes hacia usuarios y clientes.

### Tipos de notificaciones
- Sistema (internas)
- Email
- Futuro:
  - WhatsApp
  - SMS

### Arquitectura
- Interfaces abstractas
- Implementaciones intercambiables

Ejemplo conceptual:
- NotificationProvider (interface)
  - EmailProvider
  - WhatsAppProvider (futuro)

### Estado inicial
- Email: **Mailhog** (entorno de desarrollo)
- Producción: proveedor externo (definido después)

---

## T5 — Mensajería Externa (Clientes)

**Responsabilidad:** Comunicación con clientes finales.

Usado por:
- Recordatorios de citas
- Confirmaciones
- Post-venta
- Solicitud de reviews

Características:
- No acoplado a un proveedor específico
- Canal configurable por empresa / plan

---

## T6 — Auditoría y Eventos del Sistema

**Responsabilidad:** Trazabilidad y análisis interno.

Incluye:
- Eventos de dominio:
  - Cita creada
  - Estado cambiado
  - Pago recibido
- Eventos técnicos:
  - Login
  - Cambios de configuración
- Base para:
  - Analytics
  - Insights
  - Debugging

---

## T7 — Stack Tecnológico (Definido)

### Frontend
- Next.js
- React
- TypeScript
- App Router
- SSR / SSG según contexto

### Backend
- API dentro de Next.js (initial)
- Arquitectura modular
- Separación clara por dominios

### Base de Datos
- PostgreSQL
- Modelo relacional
- Multi-tenant enforced a nivel de datos

### Infraestructura
- SaaS web
- Preparado para escalar horizontalmente

---

## Principios Técnicos Transversales

- Tipado fuerte (TypeScript end-to-end)
- Interfaces antes que implementaciones
- Modularidad por dominio
- No dependencias rígidas entre módulos
- Todo es multi-tenant por defecto
- Seguridad por diseño

---

## Relación con Módulos Funcionales

Todos los módulos funcionales:
- Usan autenticación
- Respetan roles
- Usan feature flags
- Emiten eventos
- Consumen notificaciones

Ejemplo:
- Agendamiento → Notificaciones
- CRM → Roles
- IA → Planes
- Analytics → Eventos

---

## Resultado Esperado

Un sistema:
- Escalable
- Multi-cliente
- Seguro
- Modular
- Fácil de extender
- Preparado para crecimiento técnico y comercial
