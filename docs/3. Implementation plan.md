# Plan de Implementación — Arquitectura Base & Módulos Transversales

## Documentos de Arquitectura

> [!NOTE]
> Consultar estos documentos para decisiones de diseño detalladas:
> - [User, Company & Billing](./architecture/user-company-billing.md) — Usuarios, empresas, roles, suscripciones
> - [Calendar & Scheduling](./architecture/calendar-scheduling.md) — Citas, profesionales, horarios
> - [Templating Engine](./architecture/templating-engine.md) — Sitios públicos, temas ZIP/11ty, inyección de variables
> - [Analytics & Tracking](./architecture/analytics.md) — Seguimiento de visitas, GTM, Facebook Conversions API
> - [Design System](./design/design-system.md) — Colores, tipografía y tokens de UI

---

## Principios Arquitectónicos

- Monorepo único (inicial)
- Next.js + App Router
- TypeScript end-to-end
- tRPC como capa de API (frontend ↔ backend)
- Prisma + PostgreSQL
- Infraestructura abstracta (interfaces primero)
- Multi-tenant por diseño
- Dominio > framework

---

## Stack Tecnológico Base

### Frontend / Backend
- Next.js
- React
- TypeScript
- tRPC
- Zod
- Tailwind CSS + shadcn/ui
### Persistencia
- PostgreSQL
- Prisma ORM
- Migraciones desde el día 1
### Infraestructura (desarrollo)
- Docker Compose
- PostgreSQL
- Redis
- MailHog

---

## FASE 1 — Setup del Proyecto

### Inicialización
- Crear proyecto Next.js con TypeScript
- Configurar ESLint y Prettier
- Definir path aliases
- Manejo de variables de entorno (.env.local / .env.example)

---
## FASE 2 — tRPC como columna vertebral

- tRPC como única capa de comunicación frontend ↔ backend
- Contexto tRPC incluye:
    - Usuario autenticado
    - Empresa activa (tenant)
    - Cliente Prisma
    - Feature flags
    - Metadata del request

Estructura sugerida:

```
src/
  server/
    trpc/
      context.ts
      router.ts
      routers/
  app/
  lib/
```

---

## FASE 3 — Docker & Entorno Local

### docker-compose.yml (dev)

Servicios:

- postgres
    
- redis
    
- mailhog
    

Objetivo:

- Un solo comando levanta todo el entorno
    
- Backend depende únicamente de estos servicios
    

---

## FASE 4 — Módulos Transversales

Estos módulos no conocen el dominio del negocio.  
El dominio depende de ellos, nunca al revés.

---

### T1 — Base de Datos

- Prisma Client único
    
- Todas las queries filtradas por companyId
    
- Helpers de contexto multi-tenant
    
- Soft deletes donde aplique
    

---

### T2 — Autenticación & Autorización

- Autenticación desacoplada de tRPC
    
- Autorización por rol y empresa
    
- Helpers:
    
    - requireAuth
        
    - requireCompany
        
    - requireRole
        

---

### T3 — Storage (S3 abstracto)

Interface:

- upload
    
- delete
    
- getPublicUrl
    

Implementaciones:

- LocalStorageProvider (dev)
    
- S3StorageProvider (prod)
    

---

### T4 — Mail / Notificaciones

Interface:

- sendMail
    

Implementaciones:

- MailhogProvider (dev)
    
- SendgridProvider (prod)
    

---

### T5 — Queues & Jobs

Interface:

- enqueue
    
- process
    

Implementación inicial:

- RedisQueueProvider
    

---

### T6 — Cache & Rate Limiting

- Redis como cache
    
- Rate limiting para:
    
    - Autenticación
        
    - Agente IA
        

---

### T7 — Feature Flags & Planes

- Resolver centralizado de features
    
- Evaluación por plan y rol
    
- Helpers reutilizables
    

---

### T8 — Eventos & Auditoría

- Event bus interno
    
- Eventos de dominio y sistema
    
- Base para analytics e insights
    

---

## FASE 5 — Layout & UI Base

- Layout principal del dashboard
    
- Sidebar y header
    
- Cambio de empresa
    
- Guards por rol y plan
    
- UI Kit con shadcn/ui
    

---

## FASE 6 — Core de Empresa (Módulo 1)

- Empresa
    
- Usuarios
    
- Roles
    
- Branding
    
- Brief de marketing
    
- Políticas
    
- Sedes
    

Routers tRPC por dominio:

- companyRouter
    
- userRouter
    
- brandingRouter
    

---

## FASE 7 — Módulos Funcionales

Orden recomendado:

1. Servicios & Recursos
2. Agendamiento (Calendar & Scheduling)
3. CRM
4. Post-venta
5. Pagos & Billing
6. Agente IA
7. Analytics

### Módulo 2: Agendamiento

Ver: [Calendar & Scheduling Architecture](./architecture/calendar-scheduling.md)

Entidades principales:
- **Location** — Sedes físicas (Enterprise: múltiples)
- **Professional** — Usuarios que proveen servicios
- **Service** — Tipos de servicio con duración fija
- **Resource** — Salas/equipos (Pro feature)
- **Appointment** — Citas con cliente, profesional, servicio

Flujos:
- Booking público (clientes)
- Booking interno (staff/admin)
- Walk-ins
- Gestión de horarios (Location + Professional)

Feature gating:
| Feature | Free | Pro | Enterprise |
|---------|------|-----|------------|
| Profesionales | 1-3 | ∞ | ∞ |
| Recursos/salas | ❌ | ✅ | ✅ |
| Múltiples sedes | ❌ | ❌ | ✅ |

### Módulo 3: Templating Engine (Sitios Públicos)

Ver: [Templating Engine Architecture](./architecture/templating-engine.md)

**Objetivo:** Renderizar sitios públicos (landing pages) únicos por cliente.

**Tecnología:**
- **Input:** ZIP con build de 11ty (HTML/CSS/JS estático)
- **Runtime:** Next.js Route Handler (`[[...path]]`) intercepta requests por `Host/Origin`
- **Inyección:** Search & Replace en `index.html` (Insertar `<script>window.TEMPLATE_DATA = ...</script>`)

**Gestión:**
- Super Admin sube templates base
- Clientes suben templates custom (si el plan lo permite)
- Storage en S3 (o disco local en dev)

### Módulo 5: Pagos & Billing


Ver: [User, Company & Billing Architecture](./architecture/user-company-billing.md)

- Billing por empresa (no por usuario)
- Estados de suscripción: trial, active, past_due, suspended, cancelled
- Prevención de abuso: bloquear creación de empresas si hay deudas
- Stripe como payment provider

---

Cada módulo:

- Tiene su router tRPC
- Usa providers abstractos
- Emite eventos
- Respeta el tenant
    

---

## Estructura de Carpetas Recomendada

```
src/
  app/
  server/
    trpc/
    db/
    providers/
      mail/
      storage/
      queue/
    modules/
      company/
      services/
      scheduling/
      crm/
      ai/
      analytics/
  lib/
  ui/
```

---

## Regla de Oro

Nunca importar infraestructura concreta en el dominio.  
El dominio solo conoce interfaces, contexto y eventos.

---

## Resultado Esperado

- Sistema limpio desde el día 1
    
- Infraestructura intercambiable
    
- Dominio estable
    
- tRPC como columna vertebral
    
- Preparado para escalar a producción y equipo