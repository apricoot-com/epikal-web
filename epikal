#!/bin/bash

# Epikal CLI - Wrapper for Docker Compose and Development Tasks
# This script provides a simple interface to manage the development and production environments.

COMMAND=$1
SUBCOMMAND=$2

# Help function
show_help() {
    echo "Usage: ./epikal [dev|prod] [start|stop|logs|restart|shell]"
    echo ""
    echo "Environments:"
    echo "  dev   Managed by docker-compose.dev.yml (Postgres, Redis, MailHog)"
    echo "  prod  Managed by docker-compose.prod.yml (Web, Postgres, Redis)"
    echo ""
    echo "Commands:"
    echo "  start    Start the environment (up -d)"
    echo "  stop     Stop the environment (down)"
    echo "  clear    Stop and remove all data/volumes (down -v)"
    echo "  logs     View container logs (logs -f)"
    echo "  restart  Restart the environment"
    echo "  shell    Open a shell in the web container (prod only) or db"
    echo "  build    Rebuild containers (prod only)"
}

if [ -z "$COMMAND" ] || [ "$COMMAND" == "help" ] || [ "$COMMAND" == "--help" ]; then
    show_help
    exit 0
fi

if [ -z "$SUBCOMMAND" ] && [ "$COMMAND" != "help" ]; then
    show_help
    exit 1
fi

case "$COMMAND" in
    dev)
        COMPOSE_FILE="docker-compose.dev.yml"
        SERVICE_NAME=""
        ;;
    prod)
        COMPOSE_FILE="docker-compose.prod.yml"
        SERVICE_NAME="web"
        ;;
    *)
        echo "Error: Unknown environment '$COMMAND'"
        show_help
        exit 1
        ;;
esac

case "$SUBCOMMAND" in
    start)
        echo "ğŸš€ Starting $COMMAND environment..."
        if [ "$COMMAND" == "prod" ]; then
            docker compose -f $COMPOSE_FILE up -d --build
            echo "ğŸ“Š Waiting for migrations to complete..."
            docker compose -f $COMPOSE_FILE logs -f web | grep -m 1 "Starting server..."
        else
            docker compose -f $COMPOSE_FILE up -d
            echo "ğŸ³ Waiting for database..."
            until docker compose -f $COMPOSE_FILE exec postgres pg_isready -U epikal -d epikal > /dev/null 2>&1; do
                sleep 1
            done
            echo "ğŸ“¦ Running migrations..."
            npm run db:migrate
            echo "ğŸŒ± Seeding database..."
            npm run db:seed
            echo "ğŸš€ Starting development server..."
            npm run dev
        fi
        ;;
    stop)
        echo "ğŸ›‘ Stopping $COMMAND environment..."
        docker compose -f $COMPOSE_FILE down
        ;;
    clear)
        echo "ğŸ§¹ Clearing $COMMAND environment and data..."
        docker compose -f $COMPOSE_FILE down -v
        ;;
    logs)
        docker compose -f $COMPOSE_FILE logs -f $SERVICE_NAME
        ;;
    restart)
        echo "ğŸ”„ Restarting $COMMAND environment..."
        docker compose -f $COMPOSE_FILE restart
        ;;
    build)
        echo "ğŸ—ï¸ Building $COMMAND containers..."
        docker compose -f $COMPOSE_FILE build
        ;;
    shell)
        if [ "$COMMAND" == "prod" ]; then
             docker compose -f $COMPOSE_FILE exec web sh
        else
             docker compose -f $COMPOSE_FILE exec postgres psql -U epikal -d epikal
        fi
        ;;
    *)
        echo "Error: Unknown command '$SUBCOMMAND'"
        show_help
        exit 1
        ;;
esac
